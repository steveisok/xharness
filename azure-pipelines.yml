variables:
  - template: eng/common-variables.yml
  - name: Build.Repository.Clean
    value: true
  - name: _HelixType
    value: build/product
  - name: _HelixSource
    value: pr/dotnet/xharness/$(Build.SourceBranch)
  - name: _HelixTestType
    value: test/product/
  - name: _XUnitProject
    value: $(Build.SourcesDirectory)/tests/XHarness.Tests/XHarness.Tests.csproj
  - name: _XUnitTargetFramework
    value: netcoreapp3.1
  - name: _XUnitRunnerVersion
    value: 2.4.1
  - name: _DotNetCliPackageType
    value: sdk
  - name: _DotNetCliVersion
    value: 3.1.101
  - name: _HelixAccessToken
    value: ''

# CI and PR triggers
trigger:
  batch: true
  branches:
    include:
    - master

pr:
  branches:
    include:
    - master

stages:
- stage: build
  displayName: Build
  jobs:
  - template: /eng/common/templates/jobs/jobs.yml
    parameters:
      enableTelemetry: true
      enablePublishBuildArtifacts: true
      enableMicrobuild: true
      enablePublishUsingPipelines: true
      enablePublishBuildAssets: true
      helixRepo: dotnet/xharness

      jobs:
      - job: OSX
        pool:
          name: Hosted macOS
        strategy:
          matrix:
            Debug:
              _BuildConfig: Debug
        steps:
        - script: eng/common/cibuild.sh
            --configuration $(_BuildConfig)
            --prepareMachine
            $(_InternalBuildArgs)
            /p:Test=false
          name: Build
          displayName: Build
          condition: succeeded()

        - bash: |
            targetDir=$(Build.ArtifactStagingDirectory)/OSX.IntegrationTests
            mkdir $targetDir
            cp tests/integration-tests/osx-helix-payload.sh $targetDir
            cp artifacts/packages/$(_BuildConfig)/Shipping/Microsoft.DotNet.XHarness.CLI* $targetDir
          displayName: Prepare IntegrationTests artifact
          workingDirectory: $(Build.SourcesDirectory)

        - publish: $(Build.ArtifactStagingDirectory)/OSX.IntegrationTests
          artifact: Microsoft.DotNet.XHarness.CLI.OSX.IntegrationTests

- stage: test
  displayName: Run Integration Tests
  dependsOn: build
  jobs:
  - job: integration_tests
    displayName: iOS Integration Tests
    pool:
        name: Hosted macOS
    steps:
    - download: current
      artifact: Microsoft.DotNet.XHarness.CLI.OSX.IntegrationTests

    - template: /eng/common/templates/steps/send-to-helix.yml
      parameters:
        DisplayNamePrefix: Run Tests
        HelixBaseUri: https://helix.int-dot.net/
        HelixType: test/product/
        IncludeDotNetCli: true
        DotNetCliPackageType: sdk
        DotNetCliVersion: 3.1.201
        WaitForWorkItemCompletion: true
        EnableXUnitReporter: true
        HelixTargetQueues: osx.1015.amd64.ios.open
        Creator: xharness
        WorkItemDirectory: $(Pipeline.Workspace)/Microsoft.DotNet.XHarness.CLI.OSX.IntegrationTests
        WorkItemCommand: ./osx-helix-payload.sh
        WorkItemTimeout: 00:10:00
